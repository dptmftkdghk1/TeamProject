<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
<head>
    <meta charset='utf-8' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- 화면 해상도에 따라 글자 크기 대응(모바일 대응) -->
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <!-- jquery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- fullcalendar CDN -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/main.min.js'></script>
    <!-- fullcalendar 언어 CDN -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.8.0/locales-all.min.js'></script>
    <style>
        /* body 스타일 */
        html, body {
            overflow: hidden;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }
        /* 캘린더 위의 해더 스타일(날짜가 있는 부분) */
        .fc-header-toolbar {
            padding-top: 1em;
            padding-left: 1em;
            padding-right: 1em;
        }

    </style>
</head>
<body style="padding:30px;">
<!-- calendar 태그 -->
<div id='calendar-container'>
    <div id='calendar'></div>
</div>
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">일정 추가</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                일정이름 : <input type="text" id="title"/><br/>
                시작시간 : <input type="datetime-local" id="start" class="start-date" autocomplete="off"><br/>
                종료시간 : <input type="datetime-local" id="end" class="end-date" autocomplete="off"><br/>
                배경색상 :
                <select id="color">
                    <option value="red">빨강색</option>
                    <option value="orange">주황색</option>
                    <option value="yellow">노랑색</option>
                    <option value="green">초록색</option>
                    <option value="blue">파랑색</option>
                    <option value="indigo">남색</option>
                    <option value="purple">보라색</option>
                </select> <br>
                내용 : <textarea id="text"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submit">추가</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel1">일정 확인</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
<!--                일정제목: <span th:text="${schedule.title}"></span> <br>-->
<!--                시작시간: <span th:text="${#temporals.format(schedule.start, 'yyyy년MM월dd일 HH시mm분')}"></span> <br>-->
<!--                종료시간: <span th:text="${#temporals.format(schedule.end, 'yyyy년MM월dd일 HH시mm분')}"></span> <br>-->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="submit1">수정</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>
<script>
    // 날짜 포맷 함수
    function formatDate(dateString) {
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // 1월은 0이므로 +1
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${year}년 ${month}월 ${day}일 ${hours}시 ${minutes}분`;
    }
    fetch(`/schedule`)
        .then(response => response.json())
        .then(schedules => {
            (function(){
                $(function(){
                    // calendar element 취득
                    var calendarEl = $('#calendar')[0];
                    // full-calendar 생성하기
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        height: '700px', // calendar 높이 설정
                        expandRows: true, // 화면에 맞게 높이 재설정
                        // slotMinTime: '08:00', // Day 캘린더에서 시작 시간
                        // slotMaxTime: '20:00', // Day 캘린더에서 종료 시간
                        customButtons: {
                            myCustomButton:{
                                text:"일정 추가",
                                click : function(){
                                    $("#exampleModal").modal("show");
                                }
                            }
                        },
                        // 해더에 표시할 툴바
                        headerToolbar: {
                            left: 'myCustomButton',
                            center: 'title',
                            right: 'prev today next'
                        },
                        initialView: 'dayGridMonth', // 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
                        // navLinks: true, // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
                        editable: true, // 수정 가능?
                        // selectable: true, // 달력 일자 드래그 설정가능
                        nowIndicator: true, // 현재 시간 마크
                        dayMaxEvents: true, // 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)
                        locale: 'ko', // 한국어 설정
                        eventClick: function (obj){ // 이벤트를 클릭하면 발생하는 이벤트
                            // $("#exampleModal1").modal("show");
                            const eventData = obj.event;
                            const no = eventData.extendedProps.no;
                            console.log(JSON.stringify(eventData))
                            fetch(`/schedule/get_schedule?no=${no}`)
                                .then(response => response.json())
                                .then(data => {
                                    // console.log("조회한 일정:", JSON.stringify(data));
                                    // 모달에 데이터 표시
                                    $("#exampleModal1 .modal-body").html(`
                                        일정: <span>${data.title}</span><br>
                                        시작 시간: <span>${formatDate(data.start)}</span><br>
                                        종료 시간: <span>${data.end ? formatDate(data.end) : '없음'}</span><br>
                                        내용: <span>${data.text}</span>
                                    `);
                                    $("#exampleModal1").modal("show");
                                })
                                .catch(error => {
                                    console.error("조회 오류:", error);
                                });
                        },
                        eventAdd: function(obj) { // 이벤트가 추가되면 발생하는 이벤트
                            console.log(obj.event.extendedProps.text);
                            const o = {};
                            o.title = obj.event.title;
                            // o.start = obj.event.start;
                            // o.end = obj.event.end;
                            // 시작 및 종료 시간을 UTC에서 한국 시간으로 변환
                            const startDate = new Date(obj.event.start);
                            const endDate = new Date(obj.event.end);

                            // 한국 시간으로 변환
                            const options = { timeZone: "Asia/Seoul", hour12: false };
                            o.start = startDate.toLocaleString("sv-SE", options).replace(" ", "T");
                            if(endDate == "Thu Jan 01 1970 09:00:00 GMT+0900 (GMT+09:00)"){
                                o.end = null;
                            }else{
                                o.end = endDate.toLocaleString("sv-SE", options).replace(" ", "T");
                            }

                            o.backgroundColor = obj.event.backgroundColor;
                            o.text = obj.event.extendedProps.text;

                            console.log("이벤: " + JSON.stringify(o));
                            fetch(`/schedule/calender`, {
                                method: "POST",
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(o)
                            }).then(response => {
                                if(!response.ok){
                                    throw new Error('에러에러');
                                }
                                location.reload();
                                return response.json();
                            });
                        },
                        eventChange: function(obj) { // 이벤트가 수정되면 발생하는 이벤트
                            console.log(obj);
                        },
                        eventRemove: function(obj){ // 이벤트가 삭제되면 발생하는 이벤트
                            console.log(obj);
                        },

                        // 이벤트
                        events: schedules
                    });
                    //모달창 이벤트
                    $("#submit").on("click", function () {
                        var eventData = {
                            title: $("#title").val(),
                            start: $("#start").val(),
                            end: $("#end").val(),
                            color: $("#color").val(),
                            text: $("#text").val()
                        };
                        //빈값입력시 오류
                        if (
                            eventData.title == "" ||
                            eventData.start == "" ||
                            eventData.end == ""
                        ) {
                            alert("입력하지 않은 값이 있습니다.");

                            //끝나는 날짜가 시작하는 날짜보다 값이 크면 안됨
                        } else if ($("#start").val() > $("#end").val()) {
                            alert("시간을 잘못입력 하셨습니다.");
                        } else {
                            // 이벤트 추가
                            calendar.addEvent(eventData);
                            $("#exampleModal").modal("hide");
                            $("#title").val("");
                            $("#start").val("");
                            $("#end").val("");
                            $("#color").val("");
                        }
                    });
                    // 캘린더 랜더링
                    calendar.render();
                });
            })();
        })
</script>
</body>
</html>